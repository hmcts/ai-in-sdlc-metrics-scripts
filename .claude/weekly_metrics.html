<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI in SDLC Internal Report</title>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .header {
      background: white;
      padding: 30px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 { margin: 0 0 10px 0; color: #333; }
    .subtitle { color: #666; font-size: 14px; }
    .chart-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .chart-container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .chart-container.full-width {
      grid-column: 1 / -1;
    }
    .key-insights {
      background: white;
      padding: 35px 40px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      margin-bottom: 24px;
      border-top: 3px solid #1976D2;
    }
    .key-insights h2 {
      margin: 0 0 8px 0;
      color: #1a1a1a;
      font-size: 20px;
      font-weight: 600;
      letter-spacing: -0.02em;
    }
    .section-subtitle {
      color: #666;
      font-size: 13px;
      margin-bottom: 24px;
      font-weight: 400;
    }
    .insight-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 24px;
    }
    .insight-card {
      padding: 20px 24px;
      border: 1px solid #e5e5e5;
      background: #fafafa;
      border-radius: 6px;
      transition: all 0.2s ease;
    }
    .insight-card:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-color: #d0d0d0;
    }
    .insight-card.good { border-left: 4px solid #0D7C2E; }
    .insight-card.warning { border-left: 4px solid #E37400; }
    .insight-card.bad { border-left: 4px solid #C5221F; }
    .insight-title {
      font-weight: 500;
      margin-bottom: 8px;
      color: #5f6368;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .insight-value {
      font-size: 32px;
      font-weight: 600;
      color: #1a1a1a;
      margin: 8px 0;
      line-height: 1.2;
    }
    .insight-card.good .insight-value { color: #0D7C2E; }
    .insight-card.warning .insight-value { color: #E37400; }
    .insight-card.bad .insight-value { color: #C5221F; }
    .insight-desc {
      font-size: 13px;
      color: #70757a;
      line-height: 1.5;
      margin-top: 6px;
    }
    .category-section {
      margin-bottom: 40px;
    }
    .category-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 30px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .category-header h2 {
      margin: 0 0 5px 0;
      font-size: 24px;
      font-weight: 600;
    }
    .category-header p {
      margin: 0;
      opacity: 0.9;
      font-size: 14px;
    }
    .category-header.efficiency { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .category-header.satisfaction { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .category-header.adoption { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .category-header.quality { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }

    /* Token chart filter */
    .filter-bar {
      background: white;
      padding: 15px 30px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .filter-label {
      font-weight: 500;
      color: #333;
    }
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .toggle-slider {
      background-color: #667eea;
    }
    input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }
    .token-chart.hidden {
      display: none;
    }
    .filter-info {
      color: #666;
      font-size: 13px;
      margin-left: auto;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>AI in SDLC Internal Report</h1>
    <div class="subtitle">Performance Analysis Period: Nov 10 - Nov 21, 2025</div>
  </div>

  <!-- EFFICIENCY METRICS -->
  <div class="category-section">
    <div class="category-header efficiency">
      <h2>Efficiency Metrics</h2>
    </div>
    <div class="chart-grid">
      <div class="chart-container">
        <div id="tokensPerSPChart"></div>
      </div>
      <div class="chart-container">
        <div id="locPerTokenChart"></div>
      </div>
      <div class="chart-container">
        <div id="locPerPRChart"></div>
      </div>
      <div class="chart-container">
        <div id="locPerDevChart"></div>
      </div>
      <div class="chart-container">
        <div id="tokensPerPRTimeChart"></div>
      </div>
      <div class="chart-container" style="grid-column: span 2;">
        <div id="tokensPerTicketScatterChart"></div>
      </div>
      <div class="chart-container">
        <div id="costPerLOCChart"></div>
      </div>
      <div class="chart-container">
        <div id="costPerPRChart"></div>
      </div>
      <div class="chart-container">
        <div id="costPerSPChart"></div>
      </div>
      <div class="chart-container">
        <div id="storyPointsChart"></div>
      </div>
      <div class="chart-container">
        <div id="featurePRsChart"></div>
      </div>
    </div>
  </div>

  <!-- SATISFACTION & TRUST METRICS -->
  <div class="category-section">
    <div class="category-header satisfaction">
      <h2>Satisfaction & Trust Metrics</h2>
      <p>Code review engagement and collaboration indicators</p>
    </div>
    <div class="chart-grid">
      <div class="chart-container">
        <div id="commentsChart"></div>
      </div>
    </div>
  </div>

  <!-- ADOPTION & MATURITY METRICS -->
  <div class="category-section">
    <div class="category-header adoption">
      <h2>Adoption & Maturity Metrics</h2>
      <p>AI tool sophistication, NK/T options value, and context management</p>
    </div>
    <div class="chart-grid">
      <div class="chart-container full-width">
        <div id="logNKvsLogTChart"></div>
      </div>
      <div class="chart-container">
        <div id="contextWindowTimeChart"></div>
      </div>
      <div class="chart-container">
        <div id="compactionsChart"></div>
      </div>
    </div>
  </div>

  <!-- QUALITY METRICS -->
  <div class="category-section">
    <div class="category-header quality">
      <h2>Quality Metrics</h2>
      <p>Code quality, security, maintainability, and test coverage indicators</p>
    </div>
    <div class="chart-grid">
      <div class="chart-container">
        <div id="testCoverageChart"></div>
      </div>
      <div class="chart-container">
        <div id="cvesChart"></div>
      </div>
      <div class="chart-container">
        <div id="duplicatedLinesChart"></div>
      </div>
      <div class="chart-container">
        <div id="maintainabilityChart"></div>
      </div>
      <div class="chart-container">
        <div id="reliabilityChart"></div>
      </div>
      <div class="chart-container">
        <div id="securityChart"></div>
      </div>
      <div class="chart-container">
        <div id="codeSmellsChart"></div>
      </div>
    </div>
  </div>

  <!-- COST BREAKDOWN -->
  <div class="category-section">
    <div class="category-header" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
      <h2>Cost Breakdown</h2>
      <p>AWS Bedrock spending analysis by model and infrastructure</p>
    </div>
    <div class="chart-grid">
      <div class="chart-container">
        <div id="costModelChart"></div>
      </div>
      <div class="chart-container">
        <div id="costCategoryChart"></div>
      </div>
    </div>
  </div>

  <!-- DEVELOPER ACTIVITY -->
  <div class="category-section">
    <div class="category-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
      <h2>Developer Activity & Usage Patterns</h2>
    </div>
    <div class="chart-grid">
      <div class="chart-container full-width">
        <div id="promptCategoriesChart"></div>
      </div>
    </div>
  </div>

  <script>
    const weeklyData = [{"week":"Week 6","period":"Nov 10-14","featurePRs":5,"locPerPR":1878,"locPerDev":3130,"locPerToken":null,"commentsPerPR":1.6,"testCoverage":87.5,"cves":0,"duplicatedLines":0,"maintainability":1,"reliability":1,"security":1,"codeSmells":2,"nkt":60.35,"cycleTime":2.44,"tokensPerSP":null,"costPerLOC":0.0282,"costPerPR":52.91,"costPerSP":16.53,"storyPoints":16,"wipSP":null,"totalCost":264.53,"timeToContextWindow":null,"autoCompactions":0,"manualCompactions":0,"totalPrompts":0,"avgPromptLength":0,"topCategory":null,"topCategoryCount":0,"topSubcategory":null,"topSubcategoryCount":0,"promptCategories":{},"note":""},{"week":"Week 7","period":"Nov 17-21","featurePRs":4,"locPerPR":4051,"locPerDev":8102,"locPerToken":null,"commentsPerPR":1.25,"testCoverage":92.13,"cves":0,"duplicatedLines":0.23,"maintainability":1,"reliability":1,"security":1,"codeSmells":5.33,"nkt":136.58,"cycleTime":1.24,"tokensPerSP":null,"costPerLOC":0.0229,"costPerPR":92.83,"costPerSP":23.21,"storyPoints":16,"wipSP":null,"totalCost":371.31,"timeToContextWindow":null,"autoCompactions":0,"manualCompactions":0,"totalPrompts":0,"avgPromptLength":0,"topCategory":null,"topCategoryCount":0,"topSubcategory":null,"topSubcategoryCount":0,"promptCategories":{},"note":""}];
    const allWeeks = weeklyData; // Include ALL weeks, even Week 1 with 0s

    // Common layout settings
    const commonLayout = {
      font: { family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif' },
      plot_bgcolor: '#fafafa',
      paper_bgcolor: 'white',
      margin: { l: 60, r: 30, t: 50, b: 80 },
    };

    function createSimpleChart(elementId, yData, title, yAxisTitle, color = '#2196F3', rangeMin = 0) {
      const trace = {
        x: allWeeks.map(d => d.period),
        y: yData,
        type: 'scatter',
        mode: 'lines+markers',
        line: { color: color, width: 3 },
        marker: { size: 10, color: color },
        connectgaps: false, // Don't connect lines across null values
        hovertemplate: '<b>%{x}</b><br>' + yAxisTitle + ': %{y}<extra></extra>'
      };

      Plotly.newPlot(elementId, [trace], {
        ...commonLayout,
        title: title,
        xaxis: { title: 'Week' },
        yaxis: {
          title: yAxisTitle,
          gridcolor: '#e0e0e0',
          rangemode: 'tozero', // Ensure y-axis starts at 0
          range: [rangeMin, null] // Set minimum to 0 or custom value
        },
        height: 350,
      }, { responsive: true });
    }

    // 1. Log-Log Plot: log(NK) vs log(T)
    const weeksWithData = allWeeks.filter(d => d.nkt !== null && d.cycleTime !== null && d.featurePRs > 0);

    // Calculate NK and use actual cycle time T for each week
    const logLogData = weeksWithData.map((d, index) => {
      const T = d.cycleTime; // Actual cycle time in days
      const NK = d.nkt * T; // NK = (NK/T) * T = parallel work capacity
      return {
        period: d.period,
        week: index + 2, // Week 2, 3, 4, 5
        T: T,
        NK: NK,
        logT: Math.log10(T),
        logNK: Math.log10(NK)
      };
    });

    // Calculate linear regression for trend line
    const n = logLogData.length;
    const sumX = logLogData.reduce((sum, d) => sum + d.logT, 0);
    const sumY = logLogData.reduce((sum, d) => sum + d.logNK, 0);
    const sumXY = logLogData.reduce((sum, d) => sum + d.logT * d.logNK, 0);
    const sumX2 = logLogData.reduce((sum, d) => sum + d.logT * d.logT, 0);

    const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
    const intercept = (sumY - slope * sumX) / n;

    // Generate trend line points
    const minLogT = Math.min(...logLogData.map(d => d.logT));
    const maxLogT = Math.max(...logLogData.map(d => d.logT));
    const trendLine = [
      { x: minLogT, y: slope * minLogT + intercept },
      { x: maxLogT, y: slope * maxLogT + intercept }
    ];

    const logLogTrace = {
      x: logLogData.map(d => d.logT),
      y: logLogData.map(d => d.logNK),
      type: 'scatter',
      mode: 'markers+text',
      marker: {
        size: 14,
        color: logLogData.map(d => d.week),
        colorscale: 'Viridis',
        showscale: true,
        colorbar: {
          title: 'Week',
          titleside: 'right',
          tickmode: 'array',
          tickvals: [2, 3, 4, 5]
        }
      },
      text: logLogData.map(d => 'Week ' + d.week),
      textposition: 'top center',
      textfont: {
        size: 10,
        color: '#333'
      },
      hovertemplate: '<b>%{customdata[3]}</b><br>log(T): %{x:.3f} (T=%{customdata[0]} days)<br>log(NK): %{y:.3f} (NK=%{customdata[1]:.0f})<br>NK/T: %{customdata[2]:.1f}<extra></extra>',
      customdata: logLogData.map(d => [d.T, d.NK, d.NK / d.T, d.period]),
      name: 'Weeks'
    };

    const trendTrace = {
      x: trendLine.map(d => d.x),
      y: trendLine.map(d => d.y),
      type: 'scatter',
      mode: 'lines',
      line: { color: '#FF5722', width: 2, dash: 'dash' },
      name: `Trend (slope: ${slope.toFixed(3)})`,
      hovertemplate: 'Trend line<br>Slope: ' + slope.toFixed(3) + '<extra></extra>'
    };

    Plotly.newPlot('logNKvsLogTChart', [logLogTrace, trendTrace], {
      ...commonLayout,
      title: 'üìà Scaling Analysis: log(NK) vs log(T) with Trend',
      xaxis: {
        title: 'log(T) - Cycle Time (log days)',
        gridcolor: '#e0e0e0'
      },
      yaxis: {
        title: 'log(NK) - Parallel Work Capacity',
        gridcolor: '#e0e0e0'
      },
      annotations: [{
        text: `Slope = ${slope.toFixed(3)}<br>Scaling: NK ‚àù T<sup>${slope.toFixed(2)}</sup><br>${slope > 1 ? 'Super-linear' : slope > 0.8 ? 'Linear' : slope > 0 ? 'Sub-linear' : 'Negative'} scaling`,
        xref: 'paper',
        yref: 'paper',
        x: 0.02,
        y: 0.98,
        xanchor: 'left',
        yanchor: 'top',
        showarrow: false,
        font: { size: 11, color: '#666' },
        bgcolor: 'rgba(255,255,255,0.8)',
        borderpad: 4
      }, {
        text: `Slope indicates how parallel work capacity scales with cycle time.<br>${slope > 1 ? 'Slope > 1: Increasing cycle time leads to proportionally greater parallel work capacity.' : slope > 0.8 ? 'Slope ‚âà 1: Linear relationship - parallel work scales proportionally with cycle time.' : 'Slope < 1: Diminishing returns - longer cycles show less proportional increase in parallel work.'}`,
        xref: 'paper',
        yref: 'paper',
        x: 0.5,
        y: -0.22,
        xanchor: 'center',
        yanchor: 'top',
        showarrow: false,
        font: { size: 10, color: '#666', style: 'italic' },
        bgcolor: 'rgba(255,255,255,0.9)',
        borderpad: 6
      }],
      showlegend: true,
      legend: {
        x: 0.98,
        y: 0.02,
        xanchor: 'right',
        yanchor: 'bottom',
        bgcolor: 'rgba(255,255,255,0.8)',
        bordercolor: '#e0e0e0',
        borderwidth: 1
      },
      height: 400,
    }, { responsive: true });

    // 2a. Cost Breakdown by Model (Pie Chart)
    const costModelTrace = {
      labels: ['Claude Sonnet 4.5', 'Claude Haiku'],
      values: [625.61, 4.43],
      type: 'pie',
      marker: {
        colors: ['#2196F3', '#4CAF50']
      },
      textinfo: 'label+percent',
      textposition: 'inside',
      insidetextorientation: 'radial',
      hovertemplate: '<b>%{label}</b><br>Cost: $%{value:.2f}<br>%{percent}<extra></extra>'
    };

    Plotly.newPlot('costModelChart', [costModelTrace], {
      ...commonLayout,
      title: {
        text: 'Cost by Model (All Weeks)',
        y: 0.95
      },
      showlegend: true,
      height: 450,
      margin: { l: 40, r: 40, t: 80, b: 40 }
    }, { responsive: true });

    // 2b. Cost Breakdown by Category (Pie Chart with Infrastructure Breakdown)
    const infraBreakdown = 'Key Management: $2.47 (33.9%)<br>Security Hub: $0.00 (0.0%)<br>CloudWatch: $0.77 (10.6%)<br>Config: $2.71 (37.2%)<br>Tax: $0.87 (12.0%)<br>Other: $0.46 (6.3%)';

    const costCategoryTrace = {
      labels: ['Claude API', 'Infrastructure'],
      values: [630.03, 7.28],
      type: 'pie',
      marker: {
        colors: ['#2196F3', '#FF9800']
      },
      textinfo: 'label+percent',
      textposition: 'inside',
      insidetextorientation: 'radial',
      customdata: [
        ['Sonnet 4.5: $625.61 (99.3%)<br>Haiku: $4.43 (0.7%)'],
        [infraBreakdown]
      ],
      hovertemplate: '<b>%{label}</b><br>Cost: $%{value:.2f}<br>%{percent}<br><br>Breakdown:<br>%{customdata[0]}<extra></extra>'
    };

    Plotly.newPlot('costCategoryChart', [costCategoryTrace], {
      ...commonLayout,
      title: {
        text: 'Cost by Category (All Weeks)',
        y: 0.95
      },
      showlegend: true,
      height: 450,
      margin: { l: 40, r: 40, t: 80, b: 40 }
    }, { responsive: true });

    // 2c. Tokens per Story Point (Weeks 5, 6, 7 have transcript data)
    const tokensPerSPTrace = {
      x: allWeeks.map(d => d.period),
      y: allWeeks.map(d => d.tokensPerSP),
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#9C27B0', width: 3 },
      marker: { size: 10 },
      connectgaps: false,
      hovertemplate: '<b>%{x}</b><br>Tokens/SP: %{y:,.0f}<extra></extra>'
    };
    Plotly.newPlot('tokensPerSPChart', [tokensPerSPTrace], {
      ...commonLayout,
      title: 'Tokens per Story Point',
      xaxis: { title: 'Week' },
      yaxis: { title: 'Tokens per SP', gridcolor: '#e0e0e0', rangemode: 'tozero' },
      height: 350
    }, { responsive: true });

    // 2d. LOC per Token (Weeks 5, 6, 7 have transcript data)
    const locPerTokenTrace = {
      x: allWeeks.map(d => d.period),
      y: allWeeks.map(d => d.locPerToken ? d.locPerToken * 10000 : null),
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#FF5722', width: 3 },
      marker: { size: 10 },
      connectgaps: false,
      hovertemplate: '<b>%{x}</b><br>LOC per 10K Tokens: %{y:.2f}<extra></extra>'
    };
    Plotly.newPlot('locPerTokenChart', [locPerTokenTrace], {
      ...commonLayout,
      title: 'Lines of Code per 10,000 Tokens',
      xaxis: { title: 'Week' },
      yaxis: {
        title: 'LOC per 10K Tokens',
        gridcolor: '#e0e0e0',
        rangemode: 'tozero'
      },
      height: 350
    }, { responsive: true });

    // 2e. LOC per Developer
    const locPerDevTrace = {
      x: allWeeks.map(d => d.period),
      y: allWeeks.map(d => d.locPerDev),
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#009688', width: 3 },
      marker: { size: 10 },
      connectgaps: false,
      hovertemplate: '<b>%{x}</b><br>LOC/Dev: %{y:.0f}<extra></extra>'
    };
    Plotly.newPlot('locPerDevChart', [locPerDevTrace], {
      ...commonLayout,
      title: 'Total Lines of Code per Developer',
      xaxis: { title: 'Week' },
      yaxis: { title: 'LOC per Developer', gridcolor: '#e0e0e0', rangemode: 'tozero' },
      height: 350
    }, { responsive: true });

    // 2f. Tokens per Time to Pass PR (Weeks 5, 6, 7 have transcript data)
    const tokensPerPRTimeTrace = {
      x: allWeeks.map(d => d.period),
      y: allWeeks.map(d => d.tokensPerCycleTime),
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#00BCD4', width: 3 },
      marker: { size: 10 },
      connectgaps: false,
      hovertemplate: '<b>%{x}</b><br>Tokens/Day: %{y:,.0f}<extra></extra>'
    };
    Plotly.newPlot('tokensPerPRTimeChart', [tokensPerPRTimeTrace], {
      ...commonLayout,
      title: 'Tokens per Time to Pass PR',
      xaxis: { title: 'Week' },
      yaxis: { title: 'Tokens per Day', gridcolor: '#e0e0e0', rangemode: 'tozero' },
      height: 350
    }, { responsive: true });

    // 2f2. Tokens per Ticket Scatter Plot (by Story Point Size) - Weeks 5, 6, 7
    const ticketTokenData = [
      // Week 5
      {"ticket":"VIBE-201","sp":8,"tokens":659489888,"prNumber":67,"week":"Week 5"},
      {"ticket":"VIBE-160","sp":5,"tokens":7843552,"prNumber":66,"week":"Week 5"},
      // Week 6
      {"ticket":"VIBE-140","sp":8,"tokens":85901662,"prNumber":92,"week":"Week 6"},
      {"ticket":"VIBE-216","sp":8,"tokens":97179979,"prNumber":99,"week":"Week 6"},
      // Week 7
      {"ticket":"VIBE-169","sp":5,"tokens":98864718,"prNumber":102,"week":"Week 7"},
      {"ticket":"VIBE-180","sp":8,"tokens":789229616,"prNumber":106,"week":"Week 7"},
      {"ticket":"VIBE-143","sp":3,"tokens":94622041,"prNumber":116,"week":"Week 7"}
    ];

    // Group tickets by story point size
    const spGroups = {};
    ticketTokenData.forEach(ticket => {
      if (!spGroups[ticket.sp]) {
        spGroups[ticket.sp] = [];
      }
      spGroups[ticket.sp].push(ticket);
    });

    // Create a trace for each story point size
    const colors = {
      1: '#4CAF50',
      2: '#2196F3',
      3: '#FF9800',
      5: '#9C27B0',
      8: '#F44336',
      13: '#795548'
    };

    const allWeekNames = ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6', 'Week 7'];

    // Flatten to handle multiple tickets per week per SP size
    const scatterTraces = [];
    Object.keys(spGroups).sort((a, b) => Number(a) - Number(b)).forEach(sp => {
      const tickets = spGroups[sp];

      // For each ticket, create individual data points
      tickets.forEach(ticket => {
        scatterTraces.push({
          x: [ticket.week],
          y: [ticket.tokens],
          type: 'scatter',
          mode: 'markers',
          name: sp + ' SP',
          legendgroup: sp + ' SP',
          showlegend: scatterTraces.filter(t => t.legendgroup === sp + ' SP').length === 0,
          marker: {
            size: 10,
            color: colors[sp] || '#607D8B',
            line: { width: 1, color: '#fff' }
          },
          text: [ticket.ticket],
          hovertemplate: '<b>%{text}</b><br>Story Points: ' + ticket.sp + '<br>Week: %{x}<br>Tokens: %{y:,.0f}<extra></extra>'
        });
      });
    });

    // Add invisible dummy trace to force all weeks to show on X-axis
    scatterTraces.push({
      x: allWeekNames,
      y: allWeekNames.map(() => null),
      type: 'scatter',
      mode: 'markers',
      showlegend: false,
      hoverinfo: 'skip'
    });

    // Always render chart, even if empty
    if (scatterTraces.length > 0) {
      Plotly.newPlot('tokensPerTicketScatterChart', scatterTraces, {
        ...commonLayout,
        title: 'Tokens per Ticket by Story Point Size',
        xaxis: {
          title: 'Week',
          type: 'category',
          categoryarray: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6', 'Week 7']
        },
        yaxis: {
          title: 'Tokens Used',
          gridcolor: '#e0e0e0',
          rangemode: 'tozero'
        },
        height: 400,
        showlegend: true,
        legend: { x: 0.02, y: 0.98, bgcolor: 'rgba(255,255,255,0.9)' }
      }, { responsive: true });
    } else {
      // Show placeholder when no data
      Plotly.newPlot('tokensPerTicketScatterChart', [], {
        ...commonLayout,
        title: 'Tokens per Ticket by Story Point Size',
        xaxis: {
          title: 'Week',
          type: 'category',
          categoryarray: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6', 'Week 7']
        },
        yaxis: { title: 'Tokens Used', gridcolor: '#e0e0e0' },
        height: 400,
        annotations: [{
          text: 'No ticket data available yet.<br>Tokens will appear here once PRs with story points are merged.',
          xref: 'paper',
          yref: 'paper',
          x: 0.5,
          y: 0.5,
          showarrow: false,
          font: { size: 14, color: '#666' }
        }]
      }, { responsive: true });
    }

    // 2g. Time to Hit Context Window (Active conversation time - Weeks 5, 6, 7)
    const contextWindowTimeTrace = {
      x: allWeeks.map(d => d.period),
      y: allWeeks.map(d => d.timeToContextWindow),
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#E91E63', width: 3 },
      marker: { size: 10 },
      connectgaps: false,
      hovertemplate: '<b>%{x}</b><br>Active Time to Context Window: %{y:.2f} min<extra></extra>'
    };
    Plotly.newPlot('contextWindowTimeChart', [contextWindowTimeTrace], {
      ...commonLayout,
      title: 'Time to Hit Context Window - Active Conversation',
      xaxis: { title: 'Week' },
      yaxis: { title: 'Minutes (Active Use)', gridcolor: '#e0e0e0', rangemode: 'tozero' },
      height: 350,
      annotations: [{
        text: 'Active time excludes idle gaps >30 minutes',
        xref: 'paper',
        yref: 'paper',
        x: 0.5,
        y: -0.22,
        xanchor: 'center',
        yanchor: 'top',
        showarrow: false,
        font: { size: 10, color: '#666', style: 'italic' }
      }]
    }, { responsive: true });

    // 2g. Auto-Compactions vs Manual Compactions
    const autoCompactionsTrace = {
      x: allWeeks.map(d => d.period),
      y: allWeeks.map(d => d.autoCompactions),
      type: 'bar',
      name: 'Auto Compactions',
      marker: { color: '#4CAF50' },
      hovertemplate: '<b>%{x}</b><br>Auto: %{y}<extra></extra>'
    };

    const manualCompactionsTrace = {
      x: allWeeks.map(d => d.period),
      y: allWeeks.map(d => d.manualCompactions),
      type: 'bar',
      name: 'Manual Compactions',
      marker: { color: '#FF9800' },
      hovertemplate: '<b>%{x}</b><br>Manual: %{y}<extra></extra>'
    };

    Plotly.newPlot('compactionsChart', [autoCompactionsTrace, manualCompactionsTrace], {
      ...commonLayout,
      title: 'Auto-Compactions vs Manual Compactions',
      xaxis: { title: 'Week' },
      yaxis: { title: 'Count', gridcolor: '#e0e0e0', rangemode: 'tozero' },
      barmode: 'group',
      height: 350,
      showlegend: true
    }, { responsive: true });

    // 3. Number of Feature PRs
    createSimpleChart('featurePRsChart', allWeeks.map(d => d.featurePRs), 'Number of Feature PRs', 'Feature PRs', '#4CAF50');

    // 3. LOC per PR
    createSimpleChart('locPerPRChart', allWeeks.map(d => d.locPerPR), 'LOC per Merged PR', 'Lines of Code per PR', '#FF9800');

    // 4. Comments per PR
    createSimpleChart('commentsChart', allWeeks.map(d => d.commentsPerPR), 'Comments per PR', 'Comments per PR', '#9C27B0');

    // 5. Test Coverage
    createSimpleChart('testCoverageChart', allWeeks.map(d => d.testCoverage), 'Average Test Coverage per PR', 'Test Coverage (%)', '#4CAF50', 60);

    // 6. CVEs - Custom chart with integer y-axis from 0-5
    const cvesTrace = {
      x: allWeeks.map(d => d.period),
      y: allWeeks.map(d => d.cves),
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#f44336', width: 3 },
      marker: { size: 10, color: '#f44336' },
      connectgaps: false,
      hovertemplate: '<b>%{x}</b><br>CVEs: %{y}<extra></extra>'
    };
    Plotly.newPlot('cvesChart', [cvesTrace], {
      ...commonLayout,
      title: 'CVEs (Vulnerabilities)',
      xaxis: { title: 'Week' },
      yaxis: {
        title: 'CVEs',
        gridcolor: '#e0e0e0',
        tick0: 0,
        dtick: 1, // Increment by 1
        range: [0, 5] // Fixed range 0-5
      },
      height: 350,
    }, { responsive: true });

    // 7. Duplicated Lines
    const duplicatedLinesTrace = {
      x: allWeeks.map(d => d.period),
      y: allWeeks.map(d => d.duplicatedLines),
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#FF5722', width: 3 },
      marker: { size: 10, color: '#FF5722' },
      connectgaps: false,
      hovertemplate: '<b>%{x}</b><br>Duplicated Lines: %{y:.2f}%<extra></extra>'
    };
    Plotly.newPlot('duplicatedLinesChart', [duplicatedLinesTrace], {
      ...commonLayout,
      title: 'Duplicated Lines',
      xaxis: { title: 'Week' },
      yaxis: {
        title: 'Duplicated Lines (%)',
        gridcolor: '#e0e0e0',
        range: [0, 5]
      },
      height: 350,
    }, { responsive: true });

    // 8. Maintainability - Custom chart with inverted rating scale (A at top)
    const maintainabilityTrace = {
      x: allWeeks.map(d => d.period),
      y: allWeeks.map(d => d.maintainability),
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#4CAF50', width: 3 },
      marker: { size: 10, color: '#4CAF50' },
      connectgaps: false,
      hovertemplate: '<b>%{x}</b><br>Maintainability: %{y:.1f} (A)<extra></extra>'
    };
    Plotly.newPlot('maintainabilityChart', [maintainabilityTrace], {
      ...commonLayout,
      title: 'Maintainability Rating',
      xaxis: { title: 'Week' },
      yaxis: {
        title: 'Rating',
        gridcolor: '#e0e0e0',
        range: [5.5, 0.5], // Inverted: A (1.0) at top, E (5.0) at bottom
        tickmode: 'array',
        tickvals: [1, 2, 3, 4, 5],
        ticktext: ['A (1.0)', 'B (2.0)', 'C (3.0)', 'D (4.0)', 'E (5.0)']
      },
      height: 350,
    }, { responsive: true });

    // 9. Reliability - Custom chart with inverted rating scale (A at top)
    const reliabilityTrace = {
      x: allWeeks.map(d => d.period),
      y: allWeeks.map(d => d.reliability),
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#2196F3', width: 3 },
      marker: { size: 10, color: '#2196F3' },
      connectgaps: false,
      hovertemplate: '<b>%{x}</b><br>Reliability: %{y:.1f} (A)<extra></extra>'
    };
    Plotly.newPlot('reliabilityChart', [reliabilityTrace], {
      ...commonLayout,
      title: 'Reliability Rating',
      xaxis: { title: 'Week' },
      yaxis: {
        title: 'Rating',
        gridcolor: '#e0e0e0',
        range: [5.5, 0.5], // Inverted: A (1.0) at top, E (5.0) at bottom
        tickmode: 'array',
        tickvals: [1, 2, 3, 4, 5],
        ticktext: ['A (1.0)', 'B (2.0)', 'C (3.0)', 'D (4.0)', 'E (5.0)']
      },
      height: 350,
    }, { responsive: true });

    // 10. Security - Custom chart with inverted rating scale (A at top)
    const securityTrace = {
      x: allWeeks.map(d => d.period),
      y: allWeeks.map(d => d.security),
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#FF9800', width: 3 },
      marker: { size: 10, color: '#FF9800' },
      connectgaps: false,
      hovertemplate: '<b>%{x}</b><br>Security: %{y:.1f} (A)<extra></extra>'
    };
    Plotly.newPlot('securityChart', [securityTrace], {
      ...commonLayout,
      title: 'Security Rating',
      xaxis: { title: 'Week' },
      yaxis: {
        title: 'Rating',
        gridcolor: '#e0e0e0',
        range: [5.5, 0.5], // Inverted: A (1.0) at top, E (5.0) at bottom
        tickmode: 'array',
        tickvals: [1, 2, 3, 4, 5],
        ticktext: ['A (1.0)', 'B (2.0)', 'C (3.0)', 'D (4.0)', 'E (5.0)']
      },
      height: 350,
    }, { responsive: true });

    // 11. Code Smells
    createSimpleChart('codeSmellsChart', allWeeks.map(d => d.codeSmells), 'Average Code Smells per PR', 'Code Smells', '#FF5722');

    // 12. Cost per LOC
    const costLOCTrace = {
      x: allWeeks.map(d => d.period),
      y: allWeeks.map(d => d.costPerLOC),
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#9C27B0', width: 3 },
      marker: { size: 10 },
      connectgaps: false,
      hovertemplate: '<b>%{x}</b><br>Cost per LOC: $%{y:.4f}<extra></extra>'
    };
    Plotly.newPlot('costPerLOCChart', [costLOCTrace], {
      ...commonLayout,
      title: 'Cost per LOC',
      xaxis: { title: 'Week' },
      yaxis: {
        title: 'Cost per LOC ($)',
        gridcolor: '#e0e0e0',
        rangemode: 'tozero',
        range: [0, null]
      },
      height: 350,
    }, { responsive: true });

    // 13. Cost per PR
    const costPRTrace = {
      x: allWeeks.map(d => d.period),
      y: allWeeks.map(d => d.costPerPR),
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#FF9800', width: 3 },
      marker: { size: 10 },
      connectgaps: false,
      hovertemplate: '<b>%{x}</b><br>Cost per PR: $%{y:.2f}<extra></extra>'
    };
    Plotly.newPlot('costPerPRChart', [costPRTrace], {
      ...commonLayout,
      title: 'Cost per Feature PR',
      xaxis: { title: 'Week' },
      yaxis: {
        title: 'Cost per PR ($)',
        gridcolor: '#e0e0e0',
        rangemode: 'tozero',
        range: [0, null]
      },
      height: 350,
    }, { responsive: true });

    // 14. Story Points Completed
    createSimpleChart('storyPointsChart', allWeeks.map(d => d.storyPoints), 'Story Points Completed', 'Story Points', '#4CAF50');

    // 15. Prompt Categories Breakdown (Stacked Bar Chart)
    const categoryColors = {
      feature_development: '#4CAF50',
      bug_fix: '#FF5722',
      general: '#9E9E9E',
      code_understanding: '#2196F3',
      testing: '#FF9800',
      refactoring: '#9C27B0',
      documentation: '#00BCD4',
      code_review: '#607D8B',
      version_control: '#795548',
      configuration: '#E91E63'
    };
    const categoryLabels = {
      feature_development: 'Feature Development',
      bug_fix: 'Bug Fix',
      general: 'General',
      code_understanding: 'Code Understanding',
      testing: 'Testing',
      refactoring: 'Refactoring',
      documentation: 'Documentation',
      code_review: 'Code Review',
      version_control: 'Version Control',
      configuration: 'Configuration'
    };

    // Collect all categories across all weeks and sum their counts
    const categoryCounts = {};
    allWeeks.forEach(d => {
      if (d.promptCategories) {
        Object.keys(d.promptCategories).forEach(category => {
          if (!categoryCounts[category]) {
            categoryCounts[category] = 0;
          }
          categoryCounts[category] += d.promptCategories[category].count || 0;
        });
      }
    });

    // Sort categories by total count (descending) - largest first for bottom of stack
    const sortedCategories = Object.keys(categoryCounts).sort((a, b) => categoryCounts[b] - categoryCounts[a]);

    const categoryTraces = sortedCategories.map(category => {
      return {
        x: allWeeks.map(d => d.period),
        y: allWeeks.map((d) => {
          // Plot Weeks 5, 6, 7 (indices 4, 5, 6)
          if (!d.promptCategories || !d.promptCategories[category]) return null;
          return d.promptCategories[category].count || null;
        }),
        name: categoryLabels[category] || category,
        type: 'bar',
        marker: { color: categoryColors[category] || '#999999' },
        hovertemplate: '<b>%{x}</b><br>' + (categoryLabels[category] || category) + ': %{y}<extra></extra>'
      };
    });

    Plotly.newPlot('promptCategoriesChart', categoryTraces, {
      ...commonLayout,
      title: 'Prompt Categories Breakdown by Week',
      xaxis: { title: 'Week' },
      yaxis: {
        title: 'Number of Prompts',
        gridcolor: '#e0e0e0',
        rangemode: 'tozero'
      },
      barmode: 'stack',
      height: 400,
      margin: { l: 60, r: 30, t: 80, b: 80 },
      showlegend: true,
      legend: {
        orientation: 'h',
        yanchor: 'bottom',
        y: 1.02,
        xanchor: 'right',
        x: 1
      }
    }, { responsive: true });

    // 19. Cost per Story Point
    const costSPTrace = {
      x: allWeeks.map(d => d.period),
      y: allWeeks.map(d => d.costPerSP),
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#2196F3', width: 3 },
      marker: { size: 10 },
      connectgaps: false,
      hovertemplate: '<b>%{x}</b><br>Cost per SP: $%{y:.2f}<extra></extra>'
    };
    Plotly.newPlot('costPerSPChart', [costSPTrace], {
      ...commonLayout,
      title: 'Average Cost per Completed Story Point',
      xaxis: { title: 'Week' },
      yaxis: {
        title: 'Cost per Story Point ($)',
        gridcolor: '#e0e0e0',
        rangemode: 'tozero',
        range: [0, null]
      },
      height: 350,
    }, { responsive: true });

  </script>
</body>
</html>