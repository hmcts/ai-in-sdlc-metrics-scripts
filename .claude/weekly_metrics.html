<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI in SDLC Internal Report</title>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .header {
      background: white;
      padding: 30px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 { margin: 0 0 10px 0; color: #333; }
    .subtitle { color: #666; font-size: 14px; }
    .chart-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .chart-container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .chart-container.full-width {
      grid-column: 1 / -1;
    }
    .key-insights {
      background: white;
      padding: 35px 40px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      margin-bottom: 24px;
      border-top: 3px solid #1976D2;
    }
    .key-insights h2 {
      margin: 0 0 8px 0;
      color: #1a1a1a;
      font-size: 20px;
      font-weight: 600;
      letter-spacing: -0.02em;
    }
    .section-subtitle {
      color: #666;
      font-size: 13px;
      margin-bottom: 24px;
      font-weight: 400;
    }
    .insight-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 24px;
    }
    .insight-card {
      padding: 20px 24px;
      border: 1px solid #e5e5e5;
      background: #fafafa;
      border-radius: 6px;
      transition: all 0.2s ease;
    }
    .insight-card:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-color: #d0d0d0;
    }
    .insight-card.good { border-left: 4px solid #0D7C2E; }
    .insight-card.warning { border-left: 4px solid #E37400; }
    .insight-card.bad { border-left: 4px solid #C5221F; }
    .insight-title {
      font-weight: 500;
      margin-bottom: 8px;
      color: #5f6368;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .insight-value {
      font-size: 32px;
      font-weight: 600;
      color: #1a1a1a;
      margin: 8px 0;
      line-height: 1.2;
    }
    .insight-card.good .insight-value { color: #0D7C2E; }
    .insight-card.warning .insight-value { color: #E37400; }
    .insight-card.bad .insight-value { color: #C5221F; }
    .insight-desc {
      font-size: 13px;
      color: #70757a;
      line-height: 1.5;
      margin-top: 6px;
    }
    .category-section {
      margin-bottom: 40px;
    }
    .category-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 30px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .category-header h2 {
      margin: 0 0 5px 0;
      font-size: 24px;
      font-weight: 600;
    }
    .category-header p {
      margin: 0;
      opacity: 0.9;
      font-size: 14px;
    }
    .category-header.efficiency { background: #1f2a48; }
    .category-header.satisfaction { background: #1f2a48; }
    .category-header.adoption { background: #1f2a48; }
    .category-header.quality { background: #1f2a48; }


    /* Token chart filter */
    .filter-bar {
      background: white;
      padding: 15px 30px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .filter-label {
      font-weight: 500;
      color: #333;
    }
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .toggle-slider {
      background-color: #667eea;
    }
    input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }
    .token-chart.hidden {
      display: none;
    }
    .filter-info {
      color: #666;
      font-size: 13px;
      margin-left: auto;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>AI in SDLC Internal Report</h1>
    <div class="subtitle">Performance Analysis Period: October 7 - November 11, 2025</div>
  </div>

<!-- EFFICIENCY METRICS -->
<div class="category-section">
  <div class="category-header efficiency">
    <h2>Efficiency Metrics</h2>
  </div>

  <div class="chart-grid">
    <div class="chart-container"><div id="tokensPerSPChart"></div></div>
    <div class="chart-container"><div id="locPerTokenChart"></div></div>
    <div class="chart-container"><div id="locPerPRChart"></div></div>
    <div class="chart-container"><div id="locPerDevChart"></div></div>
    <div class="chart-container"><div id="tokensPerPRTimeChart"></div></div>

    <div class="chart-container" style="grid-column: span 2;">
      <div id="tokensPerTicketScatterChart"></div>
    </div>

    <div class="chart-container"><div id="costPerLOCChart"></div></div>
    <div class="chart-container"><div id="costPerPRChart"></div></div>
    <div class="chart-container"><div id="costPerSPChart"></div></div>
    <div class="chart-container"><div id="storyPointsChart"></div></div>
    <div class="chart-container"><div id="featurePRsChart"></div></div>
  </div>
</div> <!-- closes Efficiency Metrics section -->

  <div class="chart-grid">
    <div class="chart-container full-width">
      <div id="promptCategoriesChart"></div>
    </div>
  </div>

  <!-- SATISFACTION & TRUST METRICS -->
  <div class="category-section">
    <div class="category-header satisfaction">
      <h2>Satisfaction & Trust Metrics</h2>
      <p>Code review engagement and collaboration indicators</p>
    </div>
    <div class="chart-grid">
      <div class="chart-container">
        <div id="commentsChart"></div>
      </div>
    </div>
  </div>

  <!-- ADOPTION & MATURITY METRICS -->
  <div class="category-section">
    <div class="category-header adoption">
      <h2>Adoption & Maturity Metrics</h2>
      <p>AI tool sophistication, NK/T options value, and context management</p>
    </div>
    <div class="chart-grid">
      <div class="chart-container full-width">
        <div id="logNKvsLogTChart"></div>
      </div>
      <div class="chart-container">
        <div id="contextWindowTimeChart"></div>
      </div>
      <div class="chart-container">
        <div id="compactionsChart"></div>
      </div>
    </div>
  </div>

  <!-- QUALITY METRICS -->
  <div class="category-section">
    <div class="category-header quality">
      <h2>Quality Metrics</h2>
      <p>Code quality, security, maintainability, and test coverage indicators</p>
    </div>
    <div class="chart-grid">
      <div class="chart-container">
        <div id="testCoverageChart"></div>
      </div>
      <div class="chart-container">
        <div id="cvesChart"></div>
      </div>
      <div class="chart-container">
        <div id="duplicatedLinesChart"></div>
      </div>
      <div class="chart-container">
        <div id="maintainabilityChart"></div>
      </div>
      <div class="chart-container">
        <div id="reliabilityChart"></div>
      </div>
      <div class="chart-container">
        <div id="securityChart"></div>
      </div>
      <div class="chart-container">
        <div id="codeSmellsChart"></div>
      </div>
    </div>
  </div>

  <script>
    const weeklyData = [{"week":"Week 1","period":"Oct 7-10","featurePRs":0,"locPerPR":null,"locPerDev":0,"locPerToken":null,"commentsPerPR":0,"testCoverage":null,"cves":null,"duplicatedLines":null,"maintainability":null,"reliability":null,"security":null,"codeSmells":null,"nkt":null,"cycleTime":null,"tokensPerSP":null,"costPerLOC":null,"costPerPR":null,"costPerSP":null,"storyPoints":null,"wipSP":null,"totalCost":38.71,"timeToContextWindow":null,"autoCompactions":0,"manualCompactions":0,"totalPrompts":0,"avgPromptLength":0,"topCategory":null,"topCategoryCount":0,"topSubcategory":null,"topSubcategoryCount":0,"promptCategories":{},"note":""},{"week":"Week 2","period":"Oct 13-17","featurePRs":5,"locPerPR":2488,"locPerDev":6220,"locPerToken":null,"commentsPerPR":2,"testCoverage":null,"cves":null,"duplicatedLines":null,"maintainability":null,"reliability":null,"security":null,"codeSmells":null,"nkt":51.92,"cycleTime":0.43,"tokensPerSP":null,"costPerLOC":0.0132,"costPerPR":32.82,"costPerSP":13.68,"storyPoints":12,"wipSP":null,"totalCost":164.12,"timeToContextWindow":null,"autoCompactions":0,"manualCompactions":0,"totalPrompts":0,"avgPromptLength":0,"topCategory":null,"topCategoryCount":0,"topSubcategory":null,"topSubcategoryCount":0,"promptCategories":{},"note":""},{"week":"Week 3","period":"Oct 20-24","featurePRs":6,"locPerPR":1536,"locPerDev":4608,"locPerToken":null,"commentsPerPR":1,"testCoverage":79.86,"cves":0,"duplicatedLines":0,"maintainability":1,"reliability":1,"security":1,"codeSmells":5.2,"nkt":125.55,"cycleTime":0.96,"tokensPerSP":null,"costPerLOC":0.02,"costPerPR":30.65,"costPerSP":9.2,"storyPoints":20,"wipSP":null,"totalCost":183.92,"timeToContextWindow":null,"autoCompactions":0,"manualCompactions":0,"totalPrompts":0,"avgPromptLength":0,"topCategory":null,"topCategoryCount":0,"topSubcategory":null,"topSubcategoryCount":0,"promptCategories":{},"note":""},{"week":"Week 4","period":"Oct 27-31","featurePRs":5,"locPerPR":1154,"locPerDev":1442,"locPerToken":null,"commentsPerPR":1,"testCoverage":85.23,"cves":0,"duplicatedLines":0,"maintainability":1,"reliability":1,"security":1,"codeSmells":2.2,"nkt":31.81,"cycleTime":3.08,"tokensPerSP":null,"costPerLOC":0.0399,"costPerPR":46.06,"costPerSP":19.19,"storyPoints":12,"wipSP":null,"totalCost":230.29,"timeToContextWindow":null,"autoCompactions":0,"manualCompactions":0,"totalPrompts":0,"avgPromptLength":0,"topCategory":null,"topCategoryCount":0,"topSubcategory":null,"topSubcategoryCount":0,"promptCategories":{},"note":""},{"week":"Week 5","period":"Nov 3-7","featurePRs":4,"locPerPR":1948,"locPerDev":3895,"locPerToken":0.00001167,"commentsPerPR":1,"testCoverage":89.77,"cves":0,"duplicatedLines":0,"maintainability":1,"reliability":1,"security":1,"codeSmells":3.25,"nkt":51.16,"cycleTime":1.61,"tokensPerSP":51333342,"tokensPerCycleTime":103602211,"costPerLOC":0.0498,"costPerPR":96.9,"costPerSP":27.69,"storyPoints":14,"wipSP":null,"totalCost":387.59,"timeToContextWindow":101.53,"autoCompactions":0,"manualCompactions":16,"totalPrompts":336,"avgPromptLength":80,"topCategory":"general","topCategoryCount":130,"topSubcategory":null,"topSubcategoryCount":0,"promptCategories":{"general":{"count":130},"feature_development":{"count":84},"bug_fix":{"count":52},"testing":{"count":43},"version_control":{"count":10},"configuration":{"count":7},"documentation":{"count":5},"code_understanding":{"count":3},"code_review":{"count":2}},"note":""},{"week":"Week 6","period":"Nov 10-14","featurePRs":5,"locPerPR":1878,"locPerDev":3130,"locPerToken":0.00005129,"commentsPerPR":1.6,"testCoverage":87.5,"cves":0,"duplicatedLines":0,"maintainability":1,"reliability":1,"security":1,"codeSmells":2,"nkt":60.35,"cycleTime":2.44,"tokensPerSP":11442603,"tokensPerCycleTime":15006692,"costPerLOC":0.0282,"costPerPR":52.91,"costPerSP":16.53,"storyPoints":16,"wipSP":null,"totalCost":264.53,"timeToContextWindow":88.6,"autoCompactions":0,"manualCompactions":11,"totalPrompts":68,"avgPromptLength":87,"topCategory":"general","topCategoryCount":30,"topSubcategory":null,"topSubcategoryCount":0,"promptCategories":{"general":{"count":30},"feature_development":{"count":23},"bug_fix":{"count":10},"testing":{"count":2},"version_control":{"count":1},"code_review":{"count":1},"code_understanding":{"count":1}},"note":""},{"week":"Week 7","period":"Nov 17-21","featurePRs":4,"locPerPR":4051,"locPerDev":8102,"locPerToken":0.00001649,"commentsPerPR":1.25,"testCoverage":92.13,"cves":0,"duplicatedLines":0.23,"maintainability":1,"reliability":1,"security":1,"codeSmells":5.33,"nkt":136.58,"cycleTime":1.24,"tokensPerSP":61419773,"tokensPerCycleTime":198128301,"costPerLOC":0.0229,"costPerPR":92.83,"costPerSP":23.21,"storyPoints":16,"wipSP":null,"totalCost":371.31,"timeToContextWindow":93.8,"autoCompactions":0,"manualCompactions":28,"totalPrompts":175,"avgPromptLength":81,"topCategory":"general","topCategoryCount":63,"topSubcategory":null,"topSubcategoryCount":0,"promptCategories":{"general":{"count":63},"feature_development":{"count":53},"bug_fix":{"count":47},"testing":{"count":7},"version_control":{"count":3},"documentation":{"count":1},"code_review":{"count":1}},"note":""}];
    const allWeeks = weeklyData; // Include ALL weeks, even Week 1 with 0s

    // Common layout settings
    const commonLayout = {
      font: { family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif' },
      plot_bgcolor: '#fafafa',
      paper_bgcolor: 'white',
      margin: { l: 60, r: 30, t: 50, b: 80 },
    };

    function createSimpleChart(elementId, yData, title, yAxisTitle, color = '#2196F3', rangeMin = 0) {
      const trace = {
        x: allWeeks.map(d => d.period),
        y: yData,
        type: 'scatter',
        mode: 'lines+markers',
        line: { color: color, width: 3 },
        marker: { size: 10, color: color },
        connectgaps: false, // Don't connect lines across null values
        hovertemplate: '<b>%{x}</b><br>' + yAxisTitle + ': %{y}<extra></extra>'
      };

      Plotly.newPlot(elementId, [trace], {
        ...commonLayout,
        title: title,
        xaxis: { title: 'Week' },
        yaxis: {
          title: yAxisTitle,
          gridcolor: '#e0e0e0',
          rangemode: 'tozero', // Ensure y-axis starts at 0
          range: [rangeMin, null] // Set minimum to 0 or custom value
        },
        height: 350,
      }, { responsive: true });
    }

    // 1. Log-Log Plot: log(NK) vs log(T)
    const weeksWithData = allWeeks.filter(
      d => d.nkt !== null && d.cycleTime !== null && d.featurePRs > 0
    );

    // Compute log(T) and log(NK)
    const logLogData = weeksWithData.map(d => {
      const T = d.cycleTime;
      const NK = d.nkt * T;
      return {
        period: d.period,
        T,
        NK,
        logT: Math.log10(T),
        logNK: Math.log10(NK)
      };
    });

    // SCATTER POINTS (actual data)
    const scatterTrace = {
      x: logLogData.map(d => d.logT),
      y: logLogData.map(d => d.logNK),
      mode: "markers",
      type: "scatter",
      marker: {
        size: 10,
        color: "#2196F3"
      },
      name: "Weeks",
      hovertemplate:
        "<b>%{customdata}</b><br>" +
        "log(T): %{x:.3f}<br>" +
        "log(NK): %{y:.3f}<extra></extra>",
      customdata: logLogData.map(d => d.period)
    };

    // REFERENCE LINE x = y
    const minVal = Math.min(
      ...logLogData.map(d => d.logT),
      ...logLogData.map(d => d.logNK)
    );
    const maxVal = Math.max(
      ...logLogData.map(d => d.logT),
      ...logLogData.map(d => d.logNK)
    );

    const xyLineTrace = {
      x: [minVal, maxVal],
      y: [minVal, maxVal],
      mode: "lines",
      type: "scatter",
      line: { color: "#FF5722", width: 2, dash: "dash" },
      name: "x = y (log NK = log T)",
      hoverinfo: "skip"
    };

    // FINAL PLOT
    Plotly.newPlot(
      "logNKvsLogTChart",
      [scatterTrace, xyLineTrace],
      {
        ...commonLayout,
        title: "log(NK) vs log(T)",
        xaxis: { title: "log(T)", gridcolor: "#e0e0e0" },
        yaxis: { title: "log(NK)", gridcolor: "#e0e0e0" },
        showlegend: true,
        height: 400
      },
      { responsive: true }
    );


    // 2c. Tokens per Story Point (Weeks 5, 6, 7 have transcript data)
    const tokensPerSPTrace = {
      x: allWeeks.map(d => d.period),
      y: allWeeks.map(d => d.tokensPerSP),
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#9C27B0', width: 3 },
      marker: { size: 10 },
      connectgaps: false,
      hovertemplate: '<b>%{x}</b><br>Tokens/SP: %{y:,.0f}<extra></extra>'
    };
    Plotly.newPlot('tokensPerSPChart', [tokensPerSPTrace], {
      ...commonLayout,
      title: 'Tokens per Story Point',
      xaxis: { title: 'Week' },
      yaxis: { title: 'Tokens per SP', gridcolor: '#e0e0e0', rangemode: 'tozero' },
      height: 350
    }, { responsive: true });

    // 2d. LOC per Token (Weeks 5, 6, 7 have transcript data)
    const locPerTokenTrace = {
      x: allWeeks.map(d => d.period),
      y: allWeeks.map(d => d.locPerToken ? d.locPerToken * 10000 : null),
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#FF5722', width: 3 },
      marker: { size: 10 },
      connectgaps: false,
      hovertemplate: '<b>%{x}</b><br>LOC per 10K Tokens: %{y:.2f}<extra></extra>'
    };
    Plotly.newPlot('locPerTokenChart', [locPerTokenTrace], {
      ...commonLayout,
      title: 'Lines of Code per 10,000 Tokens',
      xaxis: { title: 'Week' },
      yaxis: {
        title: 'LOC per 10K Tokens',
        gridcolor: '#e0e0e0',
        rangemode: 'tozero'
      },
      height: 350
    }, { responsive: true });

    // 2e. LOC per Developer
    const locPerDevTrace = {
      x: allWeeks.map(d => d.period),
      y: allWeeks.map(d => d.locPerDev),
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#009688', width: 3 },
      marker: { size: 10 },
      connectgaps: false,
      hovertemplate: '<b>%{x}</b><br>LOC/Dev: %{y:.0f}<extra></extra>'
    };
    Plotly.newPlot('locPerDevChart', [locPerDevTrace], {
      ...commonLayout,
      title: 'Total Lines of Code per Developer',
      xaxis: { title: 'Week' },
      yaxis: { title: 'LOC per Developer', gridcolor: '#e0e0e0', rangemode: 'tozero' },
      height: 350
    }, { responsive: true });

    // 2f. Tokens per Time to Pass PR (Weeks 5, 6, 7 have transcript data)
    const tokensPerPRTimeTrace = {
      x: allWeeks.map(d => d.period),
      y: allWeeks.map(d => d.tokensPerCycleTime),
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#00BCD4', width: 3 },
      marker: { size: 10 },
      connectgaps: false,
      hovertemplate: '<b>%{x}</b><br>Tokens/Day: %{y:,.0f}<extra></extra>'
    };
    Plotly.newPlot('tokensPerPRTimeChart', [tokensPerPRTimeTrace], {
      ...commonLayout,
      title: 'Tokens per Time to Pass PR',
      xaxis: { title: 'Week' },
      yaxis: { title: 'Tokens per Day', gridcolor: '#e0e0e0', rangemode: 'tozero' },
      height: 350
    }, { responsive: true });

    // 2f2. Tokens per Ticket Scatter Plot (by Story Point Size) - Weeks 5, 6, 7
    const ticketTokenData = [
      // Week 5
      {"ticket":"VIBE-201","sp":8,"tokens":659489888,"prNumber":67,"week":"Week 5"},
      {"ticket":"VIBE-160","sp":5,"tokens":7843552,"prNumber":66,"week":"Week 5"},
      // Week 6
      {"ticket":"VIBE-140","sp":8,"tokens":85901662,"prNumber":92,"week":"Week 6"},
      {"ticket":"VIBE-216","sp":8,"tokens":97179979,"prNumber":99,"week":"Week 6"},
      // Week 7
      {"ticket":"VIBE-169","sp":5,"tokens":98864718,"prNumber":102,"week":"Week 7"},
      {"ticket":"VIBE-180","sp":8,"tokens":789229616,"prNumber":106,"week":"Week 7"},
      {"ticket":"VIBE-143","sp":3,"tokens":94622041,"prNumber":116,"week":"Week 7"}
    ];

    // Group tickets by story point size
    const spGroups = {};
    ticketTokenData.forEach(ticket => {
      if (!spGroups[ticket.sp]) {
        spGroups[ticket.sp] = [];
      }
      spGroups[ticket.sp].push(ticket);
    });

    // Create a trace for each story point size
    const colors = {
      1: '#4CAF50',
      2: '#2196F3',
      3: '#FF9800',
      5: '#9C27B0',
      8: '#F44336',
      13: '#795548'
    };

    const allWeekNames = ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6', 'Week 7'];

    // Flatten to handle multiple tickets per week per SP size
    const scatterTraces = [];
    Object.keys(spGroups).sort((a, b) => Number(a) - Number(b)).forEach(sp => {
      const tickets = spGroups[sp];

      // For each ticket, create individual data points
      tickets.forEach(ticket => {
        scatterTraces.push({
          x: [ticket.week],
          y: [ticket.tokens],
          type: 'scatter',
          mode: 'markers',
          name: sp + ' SP',
          legendgroup: sp + ' SP',
          showlegend: scatterTraces.filter(t => t.legendgroup === sp + ' SP').length === 0,
          marker: {
            size: 10,
            color: colors[sp] || '#607D8B',
            line: { width: 1, color: '#fff' }
          },
          text: [ticket.ticket],
          hovertemplate: '<b>%{text}</b><br>Story Points: ' + ticket.sp + '<br>Week: %{x}<br>Tokens: %{y:,.0f}<extra></extra>'
        });
      });
    });

    // Add invisible dummy trace to force all weeks to show on X-axis
    scatterTraces.push({
      x: allWeekNames,
      y: allWeekNames.map(() => null),
      type: 'scatter',
      mode: 'markers',
      showlegend: false,
      hoverinfo: 'skip'
    });

    // Always render chart, even if empty
    if (scatterTraces.length > 0) {
      Plotly.newPlot('tokensPerTicketScatterChart', scatterTraces, {
        ...commonLayout,
        title: 'Tokens per Ticket by Story Point Size',
        xaxis: {
          title: 'Week',
          type: 'category',
          categoryarray: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6', 'Week 7']
        },
        yaxis: {
          title: 'Tokens Used',
          gridcolor: '#e0e0e0',
          rangemode: 'tozero'
        },
        height: 400,
        showlegend: true,
        legend: { x: 0.02, y: 0.98, bgcolor: 'rgba(255,255,255,0.9)' }
      }, { responsive: true });
    } else {
      // Show placeholder when no data
      Plotly.newPlot('tokensPerTicketScatterChart', [], {
        ...commonLayout,
        title: 'Tokens per Ticket by Story Point Size',
        xaxis: {
          title: 'Week',
          type: 'category',
          categoryarray: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6', 'Week 7']
        },
        yaxis: { title: 'Tokens Used', gridcolor: '#e0e0e0' },
        height: 400,
        annotations: [{
          text: 'No ticket data available yet.<br>Tokens will appear here once PRs with story points are merged.',
          xref: 'paper',
          yref: 'paper',
          x: 0.5,
          y: 0.5,
          showarrow: false,
          font: { size: 14, color: '#666' }
        }]
      }, { responsive: true });
    }

    // 2g. Time to Hit Context Window (Active conversation time - Weeks 5, 6, 7)
    const contextWindowTimeTrace = {
      x: allWeeks.map(d => d.period),
      y: allWeeks.map(d => d.timeToContextWindow),
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#E91E63', width: 3 },
      marker: { size: 10 },
      connectgaps: false,
      hovertemplate: '<b>%{x}</b><br>Active Time to Context Window: %{y:.2f} min<extra></extra>'
    };
    Plotly.newPlot('contextWindowTimeChart', [contextWindowTimeTrace], {
      ...commonLayout,
      title: 'Time to Hit Context Window - Active Conversation',
      xaxis: { title: 'Week' },
      yaxis: { title: 'Minutes (Active Use)', gridcolor: '#e0e0e0', range: [80, 105] },
      height: 350,
      annotations: [{
        text: 'Active time excludes idle gaps >30 minutes',
        xref: 'paper',
        yref: 'paper',
        x: 0.5,
        y: -0.22,
        xanchor: 'center',
        yanchor: 'top',
        showarrow: false,
        font: { size: 10, color: '#666', style: 'italic' }
      }]
    }, { responsive: true });

    // 2g. Auto-Compactions vs Manual Compactions
    const autoCompactionsTrace = {
      x: allWeeks.map(d => d.period),
      y: allWeeks.map(d => d.autoCompactions),
      type: 'bar',
      name: 'Auto Compactions',
      marker: { color: '#4CAF50' },
      hovertemplate: '<b>%{x}</b><br>Auto: %{y}<extra></extra>'
    };

    const manualCompactionsTrace = {
      x: allWeeks.map(d => d.period),
      y: allWeeks.map(d => d.manualCompactions),
      type: 'bar',
      name: 'Manual Compactions',
      marker: { color: '#FF9800' },
      hovertemplate: '<b>%{x}</b><br>Manual: %{y}<extra></extra>'
    };

    Plotly.newPlot('compactionsChart', [autoCompactionsTrace, manualCompactionsTrace], {
      ...commonLayout,
      title: 'Auto-Compactions vs Manual Compactions',
      xaxis: { title: 'Week' },
      yaxis: { title: 'Count', gridcolor: '#e0e0e0', rangemode: 'tozero' },
      barmode: 'group',
      height: 350,
      showlegend: true
    }, { responsive: true });

    // 3. Number of Feature PRs
    createSimpleChart('featurePRsChart', allWeeks.map(d => d.featurePRs), 'Number of Feature PRs', 'Feature PRs', '#4CAF50');

    // 3. LOC per PR
    createSimpleChart('locPerPRChart', allWeeks.map(d => d.locPerPR), 'LOC per Merged PR', 'Lines of Code per PR', '#FF9800');

    // 4. Comments per PR
    createSimpleChart('commentsChart', allWeeks.map(d => d.commentsPerPR), 'Comments per PR', 'Comments per PR', '#9C27B0');

    // 5. Test Coverage
    createSimpleChart('testCoverageChart', allWeeks.map(d => d.testCoverage), 'Average Test Coverage per PR', 'Test Coverage (%)', '#4CAF50', 60);

    // 6. CVEs - Custom chart with integer y-axis from 0-5
    const cvesTrace = {
      x: allWeeks.map(d => d.period),
      y: allWeeks.map(d => d.cves),
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#f44336', width: 3 },
      marker: { size: 10, color: '#f44336' },
      connectgaps: false,
      hovertemplate: '<b>%{x}</b><br>CVEs: %{y}<extra></extra>'
    };
    Plotly.newPlot('cvesChart', [cvesTrace], {
      ...commonLayout,
      title: 'CVEs (Vulnerabilities)',
      xaxis: { title: 'Week' },
      yaxis: {
        title: 'CVEs',
        gridcolor: '#e0e0e0',
        tick0: 0,
        dtick: 1, // Increment by 1
        range: [0, 5] // Fixed range 0-5
      },
      height: 350,
    }, { responsive: true });

    // 7. Duplicated Lines
    const duplicatedLinesTrace = {
      x: allWeeks.map(d => d.period),
      y: allWeeks.map(d => d.duplicatedLines),
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#FF5722', width: 3 },
      marker: { size: 10, color: '#FF5722' },
      connectgaps: false,
      hovertemplate: '<b>%{x}</b><br>Duplicated Lines: %{y:.2f}%<extra></extra>'
    };
    Plotly.newPlot('duplicatedLinesChart', [duplicatedLinesTrace], {
      ...commonLayout,
      title: 'Duplicated Lines',
      xaxis: { title: 'Week' },
      yaxis: {
        title: 'Duplicated Lines (%)',
        gridcolor: '#e0e0e0',
        range: [0, 0.6]
      },
      height: 350,
    }, { responsive: true });

    // 8. Maintainability - Custom chart with inverted rating scale (A at top)
    const maintainabilityTrace = {
      x: allWeeks.map(d => d.period),
      y: allWeeks.map(d => d.maintainability),
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#4CAF50', width: 3 },
      marker: { size: 10, color: '#4CAF50' },
      connectgaps: false,
      hovertemplate: '<b>%{x}</b><br>Maintainability: %{y:.1f} (A)<extra></extra>'
    };
    Plotly.newPlot('maintainabilityChart', [maintainabilityTrace], {
      ...commonLayout,
      title: 'Maintainability Rating',
      xaxis: { title: 'Week' },
      yaxis: {
        title: 'Rating',
        gridcolor: '#e0e0e0',
        range: [5.5, 0.5], // Inverted: A (1.0) at top, E (5.0) at bottom
        tickmode: 'array',
        tickvals: [1, 2, 3, 4, 5],
        ticktext: ['A (1.0)', 'B (2.0)', 'C (3.0)', 'D (4.0)', 'E (5.0)']
      },
      height: 350,
    }, { responsive: true });

    // 9. Reliability - Custom chart with inverted rating scale (A at top)
    const reliabilityTrace = {
      x: allWeeks.map(d => d.period),
      y: allWeeks.map(d => d.reliability),
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#2196F3', width: 3 },
      marker: { size: 10, color: '#2196F3' },
      connectgaps: false,
      hovertemplate: '<b>%{x}</b><br>Reliability: %{y:.1f} (A)<extra></extra>'
    };
    Plotly.newPlot('reliabilityChart', [reliabilityTrace], {
      ...commonLayout,
      title: 'Reliability Rating',
      xaxis: { title: 'Week' },
      yaxis: {
        title: 'Rating',
        gridcolor: '#e0e0e0',
        range: [5.5, 0.5], // Inverted: A (1.0) at top, E (5.0) at bottom
        tickmode: 'array',
        tickvals: [1, 2, 3, 4, 5],
        ticktext: ['A (1.0)', 'B (2.0)', 'C (3.0)', 'D (4.0)', 'E (5.0)']
      },
      height: 350,
    }, { responsive: true });

    // 10. Security - Custom chart with inverted rating scale (A at top)
    const securityTrace = {
      x: allWeeks.map(d => d.period),
      y: allWeeks.map(d => d.security),
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#FF9800', width: 3 },
      marker: { size: 10, color: '#FF9800' },
      connectgaps: false,
      hovertemplate: '<b>%{x}</b><br>Security: %{y:.1f} (A)<extra></extra>'
    };
    Plotly.newPlot('securityChart', [securityTrace], {
      ...commonLayout,
      title: 'Security Rating',
      xaxis: { title: 'Week' },
      yaxis: {
        title: 'Rating',
        gridcolor: '#e0e0e0',
        range: [5.5, 0.5], // Inverted: A (1.0) at top, E (5.0) at bottom
        tickmode: 'array',
        tickvals: [1, 2, 3, 4, 5],
        ticktext: ['A (1.0)', 'B (2.0)', 'C (3.0)', 'D (4.0)', 'E (5.0)']
      },
      height: 350,
    }, { responsive: true });

    // 11. Code Smells
    createSimpleChart('codeSmellsChart', allWeeks.map(d => d.codeSmells), 'Average Code Smells per PR', 'Code Smells', '#FF5722');

    // 12. Cost per LOC
    const costLOCTrace = {
      x: allWeeks.map(d => d.period),
      y: allWeeks.map(d => d.costPerLOC),
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#9C27B0', width: 3 },
      marker: { size: 10 },
      connectgaps: false,
      hovertemplate: '<b>%{x}</b><br>Cost per LOC: $%{y:.4f}<extra></extra>'
    };
    Plotly.newPlot('costPerLOCChart', [costLOCTrace], {
      ...commonLayout,
      title: 'Cost per LOC',
      xaxis: { title: 'Week' },
      yaxis: {
        title: 'Cost per LOC ($)',
        gridcolor: '#e0e0e0',
        rangemode: 'tozero',
        range: [0, null]
      },
      height: 350,
    }, { responsive: true });

    // 13. Cost per PR
    const costPRTrace = {
      x: allWeeks.map(d => d.period),
      y: allWeeks.map(d => d.costPerPR),
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#FF9800', width: 3 },
      marker: { size: 10 },
      connectgaps: false,
      hovertemplate: '<b>%{x}</b><br>Cost per PR: $%{y:.2f}<extra></extra>'
    };
    Plotly.newPlot('costPerPRChart', [costPRTrace], {
      ...commonLayout,
      title: 'Cost per Feature PR',
      xaxis: { title: 'Week' },
      yaxis: {
        title: 'Cost per PR ($)',
        gridcolor: '#e0e0e0',
        rangemode: 'tozero',
        range: [0, null]
      },
      height: 350,
    }, { responsive: true });

    // 14. Story Points Completed
    createSimpleChart('storyPointsChart', allWeeks.map(d => d.storyPoints), 'Story Points Completed', 'Story Points', '#4CAF50');

    // 15. Prompt Categories Breakdown (Stacked Bar Chart)
    const categoryColors = {
      feature_development: '#4CAF50',
      bug_fix: '#FF5722',
      general: '#9E9E9E',
      code_understanding: '#2196F3',
      testing: '#FF9800',
      refactoring: '#9C27B0',
      documentation: '#00BCD4',
      code_review: '#607D8B',
      version_control: '#795548',
      configuration: '#E91E63'
    };
    const categoryLabels = {
      feature_development: 'Feature Development',
      bug_fix: 'Bug Fix',
      general: 'General',
      code_understanding: 'Code Understanding',
      testing: 'Testing',
      refactoring: 'Refactoring',
      documentation: 'Documentation',
      code_review: 'Code Review',
      version_control: 'Version Control',
      configuration: 'Configuration'
    };

    // Collect all categories across all weeks and sum their counts
    const categoryCounts = {};
    allWeeks.forEach(d => {
      if (d.promptCategories) {
        Object.keys(d.promptCategories).forEach(category => {
          if (!categoryCounts[category]) {
            categoryCounts[category] = 0;
          }
          categoryCounts[category] += d.promptCategories[category].count || 0;
        });
      }
    });

    // Sort categories by total count (descending) - largest first for bottom of stack
    const sortedCategories = Object.keys(categoryCounts).sort((a, b) => categoryCounts[b] - categoryCounts[a]);

    const categoryTraces = sortedCategories.map(category => {
      return {
        x: allWeeks.map(d => d.period),
        y: allWeeks.map((d) => {
          // Plot Weeks 5, 6, 7 (indices 4, 5, 6)
          if (!d.promptCategories || !d.promptCategories[category]) return null;
          return d.promptCategories[category].count || null;
        }),
        name: categoryLabels[category] || category,
        type: 'bar',
        marker: { color: categoryColors[category] || '#999999' },
        hovertemplate: '<b>%{x}</b><br>' + (categoryLabels[category] || category) + ': %{y}<extra></extra>'
      };
    });

    Plotly.newPlot('promptCategoriesChart', categoryTraces, {
      ...commonLayout,
      title: 'Prompt Categories Breakdown by Week',
      xaxis: { title: 'Week' },
      yaxis: {
        title: 'Number of Prompts',
        gridcolor: '#e0e0e0',
        rangemode: 'tozero'
      },
      barmode: 'stack',
      height: 400,
      margin: { l: 60, r: 30, t: 80, b: 80 },
      showlegend: true,
      legend: {
        orientation: 'h',
        yanchor: 'bottom',
        y: 1.02,
        xanchor: 'right',
        x: 1
      }
    }, { responsive: true });

    // 19. Cost per Story Point
    const costSPTrace = {
      x: allWeeks.map(d => d.period),
      y: allWeeks.map(d => d.costPerSP),
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#2196F3', width: 3 },
      marker: { size: 10 },
      connectgaps: false,
      hovertemplate: '<b>%{x}</b><br>Cost per SP: $%{y:.2f}<extra></extra>'
    };
    Plotly.newPlot('costPerSPChart', [costSPTrace], {
      ...commonLayout,
      title: 'Average Cost per Completed Story Point',
      xaxis: { title: 'Week' },
      yaxis: {
        title: 'Cost per Story Point ($)',
        gridcolor: '#e0e0e0',
        rangemode: 'tozero',
        range: [0, null]
      },
      height: 350,
    }, { responsive: true });

  </script>
</body>
</html>